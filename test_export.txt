# Code to run Picard CollectHsMetrics
# Generated by MethylEZ
import os
import glob
import subprocess

# Folder for the input BAM files
bam_folder = r"D:/Documentos/PhD Year 4/GUI_PUBLICATION/PICARD_HS_METRICS/LOCAL_TEST"
bam_files = glob.glob(os.path.join(bam_folder, '*.bam'))

# Output directory
output_dir = r"C:\Users\aroso\Documents\GitHub\methylEZ"
# If picard.jar is not in the same directory as this script, specify the full path
picard_jar = r"C:\Users\aroso\Documents\GitHub\methylEZ\lib\picard.jar"
# Reference genome
ref_genome = r"filtered_hg19_ensembl.fa"
# Target and bait intervals
target_intervals = r"D:/Documentos/PhD Year 4/GUI_PUBLICATION/PICARD_HS_METRICS/LOCAL_TEST/S03770311_Covered.interval_list"
bait_intervals = r"D:/Documentos/PhD Year 4/GUI_PUBLICATION/PICARD_HS_METRICS/LOCAL_TEST/S03770311_Regions.interval_list"
# Dictionary file
dict_file = r"D:/Documentos/PhD Year 4/GUI_PUBLICATION/PICARD_HS_METRICS/LOCAL_TEST/filtered_hg19_ensembl.dict"

for bam in bam_files:
    base = os.path.basename(bam)
    output_file = os.path.join(output_dir, base.replace('.bam', '_hs_metrics.txt'))
    command = (f'java -jar "{picard_jar}" CollectHsMetrics '
               f'-I "{bam}" -O "{output_file}" '
               f'-R "{ref_genome}" '
               f'-TARGET_INTERVALS "{target_intervals}" '
               f'-BAIT_INTERVALS "{bait_intervals}"')
    subprocess.run(command, shell=True, check=True)
    print(f'Processed: {bam}')